\documentclass[a4paper,10pt]{article}
%\documentclass[a4paper,10pt]{scrartcl}

\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage[table]{xcolor}  
\usepackage{pdflscape}

 \geometry{
 a4paper,
 left=20mm,
 right=20mm,
 top=20mm,
 bottom=15mm,
 }
\pagestyle{empty}

\title{CIPSI Algorithm on 3 electrons}
\author{}
\date{\today}

\begin{document}
\maketitle

In the CIPSI algorithm, the determinant space (generated by ijkl/fock) is partitioned into 3 subspaces.
The subspace S is the reference space chosen by the user. The obtained submatrix is then diagonalized to get netat energies corresponding to the lowest states. The contribution of the determinants outside of space S is evaluated with a second order perturbative algorithm.
The subspace M is formed by the determinants with a contribution superior to a given threshold. The matrix formed by the association S+M contained all determinants deemed important and is the one which will be diagonalized at the end of the procedure.
The subspace P is formed by the leftovers determinants, they can be taken into account by including their second order perturbative contribution to the energy.


In the current implementation, the \textit{cip} binary generate the subspace S and compute the perturbation of other determinants, the \textit{moy} binary construct the matrix of S+M and the \textit{bd} binary diagonalize said matrix and add various corrections (perturbation, Davidson correction, â€¦) to the final energies.


Note that cip only generate mono- and di-excited determinants of each determinants of the reference space. The active space will be smaller than the total space. 

\section{Benchmark}

Several computations were done on RbCa at $R=9.0~a.u.$ and $R=32.0~a.u.$ with differents input parameters. Results are compiled in tables \ref{table9-spin},\ref{table9-noS},\ref{table32} and show the importance of a description as accurate as possible of the reference space. Recommandation is to use the spin symmetrized algorithm (replace last call of \textit{moy} and \textit{bd} by \textit{moysym} and \textit{bdsym}) with a starting reference space containing all monoexcited determinants and to do more than one iteration. The final S space should contains 1000-2000 determinants.

Note that the rigorous algorithm is to iterate until the perturbative correction (computed by \textit{cip}) is lower than the threshold. However with the current implementation it is not time efficient (or even possible) to use \textit{cip} with an active space greater than a few thousands of determinants. This means we have to work with a rather small reference space S and a comparatively big subspace M. We also can't compute an accurate perturbative correction after the final call to \textit{bd} (too many determinants). We thus have no garranty that our results have correctly converged (outside of directly comparing to the FCI results). 

\subsection{Determinaton of the Spin }

The use of \textit{moysym} and \textit{bdsym} at the last step of the CIPSI algorithm is found to be more precise and more efficient than the use of \textit{moy}, though not by much. The gain is greater in Full CI mode (all determinants taken means no addition from YSPIPRO).

\begin{enumerate}
 
\item Using \textit{moysym} (generation of a spin symmetrized matrix prior to the diagonalisation) increase the number of determinants used because we need to use the option YSPIPRO=T. For a given set of occupied spatial orbitals one can generate several determinants each with a different combinaison of spin up/spin down. Due to the CIPSI selection some combinaison can be missing (not generated by \textit{cip} or generated but below threshold). With the option the routine will generate all the missing determinants, this is required by \textit{moysym} to compute a correctly symmetrized matrix. 
\item \textit{moysym} is usually slower than \textit{moy} 
\item \textit{bdsym} will be faster than \textit{bd} : each spin block is diagonalized independently.
\item \textit{moysym} use the old routine to order the determinant (space S first, then the rest), \textit{moy} use the one from \textit{cip} (monoexcited first, then second exc, etc...). Using the same than \textit{cip} is needed by the iterative algorithm, however it make \textit{bd} slower. Because the initial diagonalization step ncper*ncper give less acurate results, the convergence will be slower.
\item The spin of each state is imposed : avoid numerical mistake and no need to run a sorting routine afterwards.

\end{enumerate}

\subsection{Initial reference space}

Starting from the smallest space possible is more time efficient as we know that only important determinant will be included. \textit{bd} also converge faster because the initial ncper*ncper block doesn't contain any ``non-important'' elements. The total active space is however smaller increasing the possibility that we ``missed'' an important determinant. This is the case for all parasite Delta state which are not accuratly computed. But more importantly this is the case, at long-range, even for the ground state.
Starting from a bigger initial space reduce the possibility of having an issue, however it slow down the computation as the reference space now include ``non-important deterinant''.

% \section{Modification in the CIPSI source}
% 
% \begin{description}
% \item add printing of the perturbative energies to the file 60 : for each determinant, evp(m) corresponds to the ENVP contribution of said determinants towards the state 'm'.
% \item reworks the sorting of determinants in \textit{moy} : det with lower excitation number are put first (copied from \textit{cip}). \textit{moysym} still use the old format (det of space S read first)
% \item remove iord60 in ic001.f of \textit{cip}. The loop chain ``cip$>$moy$>$bd$>$cip'' now work.
% \end{description}



% \begin{landscape}
% \begin{table*}[htbp]
%   \begin{center}
%  \begin{tabular}{|c|r|r|r|r|r|r|r|r|r|r|r|r|}
%  \hline
% Spin & &\multicolumn{6}{|c|}{with Spin symmetry} & \multicolumn{5}{|c|}{Spin computed afterwards} \\
% Starting space & FCI &\multicolumn{3}{|c|}{ All monoexcited } & \multicolumn{3}{|c|}{ 2 active orbitals } & \multicolumn{3}{|c|}{ All monoexcited } & \multicolumn{2}{|c|}{ 2 active orbitals } \\
% Ref. space & & min. size & 1000 & 2000 & 1000 & 2000 & 5000 & min. size & 1000 & 2000 & 1000 & 2000 \\
%  \hline
% n. det          		&214887	& 69908	& 65905	& 62005	& 56691	& 61506	&58408	&55713 	&54249 	&52155 	&50499 	&53766 \\
% n. det S        	 	& 	& 262 	& 1020	& 3205 	& 1698 	& 2076 	&6035	&262 	& 1020 	& 3205 	& 1698 	& 2076 \\
% total time (s)    	        	&	& 366.1	& 402.4	& 357.9	& 234.0	& 248.8	&292.1	&499.5 	&373.6 	&419.3 	&286.4 	&320.2 \\
% time bd+moy (s)    		& 	& 295.4	& 326.0	& 248.1	& 175. 	& 164. 	&140.	&367.6 	&242.0 	&258.5 	&174.9 	&176.81 \\
% \hline
% \hline
% $E_{CIPSI} - E_{FCI} ~(10^{-6}~a.u.)$ & & & & & & & & & & & & \\
% $\Delta E_1 $    	&	& 107.7	& 1.93 	& 2.37 	& 2.15 	& 2.07 	&2.86	&114.4 	& 2.49 	& 2.95 	& 2.64 	& 2.39 \\
% $\Delta E_2 $    		&	& 144.1	& 2.39 	& 2.93 	& 2.34 	& 2.35 	&3.59	&158.2 	& 3.26 	& 3.75 	& 2.91 	& 2.81 \\
% $\Delta E_3 $   	 	&	& 79.1	& 1.99 	& 2.49 	& 1.96 	& 2.03 	&3.08	&89.9 	& 2.88 	& 3.39 	& 2.58 	& 2.62 \\
% $\Delta E_4 $   	 	&	& 110.3	& 2.66 	& 3.17 	& 2.56 	& 2.76 	&4.02	&132.8 	& 3.68 	& 4.20 	& 3.24 	& 3.36 \\
% $\Delta E_5 $   	 	&	& 14.1	& 1.24 	& 1.73 	& 1.30 	& 1.34 	&2.13	& 21.6 	& 1.96 	& 2.46 	& 1.65 	& 1.84 \\
% $\Delta E_6 $   	 	&	& 777.4	& 3.21 	& 3.58 	&501.1 	& 3.85 	&4.63	&799.2 	& 4.44 	& 4.43 	&540.3 	& 5.16 \\
% $\Delta E_7 $   	 	&	& 76.9	& 2.55 	& 3.01 	& 2.64 	& 2.52 	&3.86	& 87.2 	& 3.50 	& 3.87 	& 3.37 	& 3.10 \\
% $\Delta E_8$    		&	& 113.6	& 3.41 	& 3.77 	&888.1 	&16.60 	&5.09	&157.1 	& 4.45 	& 4.51 	&955.8 	& 18.6 \\
% $\Delta E_9 $  		  	&	& 81.8	& 3.22 	& 3.77 	& 3.36 	& 3.49 	&4.68	&94.1 	& 4.13 	& 4.45 	& 3.95 	& 3.92 \\
% $\Delta E_{10} $  	 	&	& 24.9 	& 1.83 	& 2.30 	& 2.19 	& 1.59 	&2.91	&29.4 	& 2.90 	& 3.17 	& 2.84 	& 2.14 \\
% $\Delta E_{11} $ 	  	&	&100.6 	& 3.35 	& 4.07 	& 3.26 	& 3.78 	&5.11	&123.2 	& 4.41 	& 4.97 	& 3.86 	& 4.31 \\
% $\Delta E_{12} $  	 	&	&132.1 	& 2.27 	& 2.65 	&962.7 	& 2.23 	&3.21	&865.5 	& 8.56 	& 3.70 	&999.4 	& 4.86 \\
% $\Delta E_{13} $ 	  	&	&281.5 	& 2.65 	& 3.26 	&934.8 	& 4.42 	&3.83	&2468. 	& 18.6 	& 5.65 	&952.3 	& 9.92 \\
% $\Delta E_{14} $  	 	&	&39.5 	& 2.21 	& 2.72 	& 2.47 	& 2.28 	&3.48	&815.1 	& 3.31 	& 3.72 	& 3.17 	& 2.92 \\
% $\Delta E_{15} $  	 	&	&109.1 	& 2.70 	& 3.27 	& 2.57 	& 2.73 	&4.22	&118.1 	& 3.88 	& 4.41 	& 3.16 	& 3.39 \\
% $\Delta E_{16} $  	 	&	&115.4 	& 3.54 	& 3.88 	& 3.32 	& 3.69 	&5.01	&127.0 	& 4.65 	& 4.83 	& 3.87 	& 4.26 \\
% $\Delta E_{17} $  	 	&	& 48.7 	& 5.04 	& 5.91 	& 1604 	&328.8 	&7.47	&58.6 	& 6.24 	& 6.46 	&1661. 	& 1965. \\
% $\Delta E_{18} $ 	  	&	&87.7 	& 3.30 	& 3.66 	&3.36  	& 3.45 	&4.90	&105.4 	& 4.68 	& 4.96 	& 3.98 	& 1646. \\
% $\Delta E_{19} $ 	 	&	&21.5 	& 4.18 	& 4.71 	& 4.76 	& 4.49 	&5.96	&25.8 	& 6.91 	& 7.24 	& 5.31 	& 5.01 \\
% $\Delta E_{20} $  	 	&	&1272.3	& 3.92 	& 6.78 	& 2029 	& 21.5 	&5.55	&1405. 	& 41.3 	& 32.7 	&2059. 	& 83.1 \\
% \hline
% \hline
% $\Delta PDM (\%)$		&	& 2.76 	& 0.01	& 0.008	& 0.006	& 0.004	&0.01	& 2.94 	&0.018 	&0.017 	&0.013 	& 0.008 \\
%  \hline
%  \end{tabular}
%  \caption{\label{tabe} \small Computation of RbCa PECs at $R=9.0~a.u.$. All tests were done with a value of ${ENVP\_max}=10^{-5}~a.u.$} 
%  \end{center}
% \end{table*}
% \end{landscape}

\begin{table*}[htbp]
  \begin{center}
 \begin{tabular}{|c|r|r|r|r|r|r|r|}
 \hline
Spin & &\multicolumn{6}{|c|}{with Spin symmetry}  \\
Starting space & FCI &\multicolumn{3}{|c|}{ All monoexcited } & \multicolumn{3}{|c|}{ 2 active orbitals }  \\
Ref. space & & min. size & 1000 & 2000 & 1000 & 2000 & 5000  \\
 \hline
n. det          		&214887	& 69908	& 65905	& 62005	& 56691	& 61506	&58408	 \\
n. det S        	 	& 	& 262 	& 1020	& 3205 	& 1698 	& 2076 	&6035	 \\
active space			&214887	&190512	&203956	&212507	&168521	&192083	&209671	\\
total time (s)    	       	&	& 366.1	& 402.4	& 357.9	& 234.0	& 248.8	&292.1	\\
time bd+moy (s)    		& 	& 295.4	& 326.0	& 248.1	& 175. 	& 164. 	&140.	 \\
\hline
\hline
$E_{CIPSI} - E_{FCI} ~(10^{-6}~a.u.)$ & & & & & & &  \\
$\Delta E_1 $    		&	& 107.7	& 1.93 	& 2.37 	& 2.15 	& 2.07 	&2.86	 \\
$\Delta E_2 $    		&	& 144.1	& 2.39 	& 2.93 	& 2.34 	& 2.35 	&3.59	 \\
$\Delta E_3 $   	 	&	& 79.1	& 1.99 	& 2.49 	& 1.96 	& 2.03 	&3.08	 \\
$\Delta E_4 $   	 	&	& 110.3	& 2.66 	& 3.17 	& 2.56 	& 2.76 	&4.02	 \\
$\Delta E_5 $   	 	&	& 14.1	& 1.24 	& 1.73 	& 1.30 	& 1.34 	&2.13	 \\
$\Delta E_6 $   	 	&	& 777.4	& 3.21 	& 3.58 	&501.1 	& 3.85 	&4.63	 \\
$\Delta E_7 $   	 	&	& 76.9	& 2.55 	& 3.01 	& 2.64 	& 2.52 	&3.86	 \\
$\Delta E_8$    		&	& 113.6	& 3.41 	& 3.77 	&888.1 	&16.60 	&5.09	 \\
$\Delta E_9 $  		  	&	& 81.8	& 3.22 	& 3.77 	& 3.36 	& 3.49 	&4.68	 \\
$\Delta E_{10} $  	 	&	& 24.9 	& 1.83 	& 2.30 	& 2.19 	& 1.59 	&2.91	\\
$\Delta E_{11} $ 	  	&	&100.6 	& 3.35 	& 4.07 	& 3.26 	& 3.78 	&5.11	 \\
$\Delta E_{12} $  	 	&	&132.1 	& 2.27 	& 2.65 	&962.7 	& 2.23 	&3.21	 \\
$\Delta E_{13} $ 	  	&	&281.5 	& 2.65 	& 3.26 	&934.8 	& 4.42 	&3.83	\\
$\Delta E_{14} $  	 	&	&39.5 	& 2.21 	& 2.72 	& 2.47 	& 2.28 	&3.48	 \\
$\Delta E_{15} $  	 	&	&109.1 	& 2.70 	& 3.27 	& 2.57 	& 2.73 	&4.22	\\
$\Delta E_{16} $  	 	&	&115.4 	& 3.54 	& 3.88 	& 3.32 	& 3.69 	&5.01	 \\
$\Delta E_{17} $  	 	&	& 48.7 	& 5.04 	& 5.91 	& 1604 	&328.8 	&7.47	 \\
$\Delta E_{18} $ 	  	&	&87.7 	& 3.30 	& 3.66 	&3.36  	& 3.45 	&4.90	 \\
$\Delta E_{19} $ 	 	&	&21.5 	& 4.18 	& 4.71 	& 4.76 	& 4.49 	&5.96 \\
$\Delta E_{20} $  	 	&	&1272.3	& 3.92 	& 6.78 	& 2029 	& 21.5 	&5.55	 \\
\hline
\hline
$\Delta PDM (\%)$		&	& 2.76 	& 0.01	& 0.008	& 0.006	& 0.004	&0.01 \\
 \hline
 \end{tabular}
 \caption{\label{table9-spin} \small Computation of RbCa PECs at $R=9.0~a.u.$. All tests were done for 20 $\Sigma$ with a value of ${ENVP\_max}=10^{-5}~a.u.$} 
 \end{center}
\end{table*}

\begin{table*}[htbp]
  \begin{center}
 \begin{tabular}{|c|r|r|r|r|r|r|r|r|r|r|r|r|}
 \hline
Spin &  & \multicolumn{5}{|c|}{Spin computed afterwards} \\
Starting space & FCI  & \multicolumn{3}{|c|}{ All monoexcited } & \multicolumn{2}{|c|}{ 2 active orbitals } \\
Ref. space &  & min. size & 1000 & 2000 & 1000 & 2000 \\
 \hline
n. det          		&214887	&55713 	&54249 	&52155 	&50499 	&53766 \\
n. det S        	 	& 	&262 	& 1020 	& 3205 	& 1698 	& 2076 \\
total time (s)    	       	&	&499.5 	&373.6 	&419.3 	&286.4 	&320.2 \\
time bd+moy (s)    		& 	&367.6 	&242.0 	&258.5 	&174.9 	&176.81 \\
\hline
\hline
$E_{CIPSI} - E_{FCI} ~(10^{-6}~a.u.)$ & & & & & & \\
$\Delta E_1 $    		&	&114.4 	& 2.49 	& 2.95 	& 2.64 	& 2.39 \\
$\Delta E_2 $    		&	&158.2 	& 3.26 	& 3.75 	& 2.91 	& 2.81 \\
$\Delta E_3 $   	 	&	&89.9 	& 2.88 	& 3.39 	& 2.58 	& 2.62 \\
$\Delta E_4 $   	 	&	&132.8 	& 3.68 	& 4.20 	& 3.24 	& 3.36 \\
$\Delta E_5 $   	 	&	& 21.6 	& 1.96 	& 2.46 	& 1.65 	& 1.84 \\
$\Delta E_6 $   	 	&	&799.2 	& 4.44 	& 4.43 	&540.3 	& 5.16 \\
$\Delta E_7 $   	 	&	& 87.2 	& 3.50 	& 3.87 	& 3.37 	& 3.10 \\
$\Delta E_8$    		&	&157.1 	& 4.45 	& 4.51 	&955.8 	& 18.6 \\
$\Delta E_9 $  		  	&	&94.1 	& 4.13 	& 4.45 	& 3.95 	& 3.92 \\
$\Delta E_{10} $  	 	&	&29.4 	& 2.90 	& 3.17 	& 2.84 	& 2.14 \\
$\Delta E_{11} $ 	  	&	&123.2 	& 4.41 	& 4.97 	& 3.86 	& 4.31 \\
$\Delta E_{12} $  	 	&	&865.5 	& 8.56 	& 3.70 	&999.4 	& 4.86 \\
$\Delta E_{13} $ 	  	&	&2468. 	& 18.6 	& 5.65 	&952.3 	& 9.92 \\
$\Delta E_{14} $  	 	&	&815.1 	& 3.31 	& 3.72 	& 3.17 	& 2.92 \\
$\Delta E_{15} $  	 	&	&118.1 	& 3.88 	& 4.41 	& 3.16 	& 3.39 \\
$\Delta E_{16} $  	 	&	&127.0 	& 4.65 	& 4.83 	& 3.87 	& 4.26 \\
$\Delta E_{17} $  	 	&	&58.6 	& 6.24 	& 6.46 	&1661. 	& 1965. \\
$\Delta E_{18} $ 	  	&	&105.4 	& 4.68 	& 4.96 	& 3.98 	& 1646. \\
$\Delta E_{19} $ 	 	&	&25.8 	& 6.91 	& 7.24 	& 5.31 	& 5.01 \\
$\Delta E_{20} $  	 	&	&1405. 	& 41.3 	& 32.7 	&2059. 	& 83.1 \\
\hline
\hline
$\Delta PDM (\%)$		&	& 2.94 	&0.018 	&0.017 	&0.013 	& 0.008 \\
 \hline
 \end{tabular}
 \caption{\label{table9-noS} \small Computation of RbCa PECs at $R=9.0~a.u.$. All tests were done for 20 $\Sigma$ with a value of ${ENVP\_max}=10^{-5}~a.u.$} 
 \end{center}
\end{table*}

\begin{table*}[htbp]
  \begin{center}
 \begin{tabular}{|c|r|r|r|r|r|}
 \hline
Starting space & FCI &\multicolumn{2}{|c|}{ All monoexcited } & \multicolumn{2}{|c|}{ 2 active orbitals } \\
Ref. space &  & 1000 & 2000  & 2000 & 5000 \\
 \hline
n. det          		&214887	&32921	&31206	&32430	&26987	\\
n. det S        	 	& 	& 1845	&2949	&2635	&6256	\\
active space			&214887	&212317	&213223	&168460	&209987	\\
total time (s)    	        &	&102.5	&148.9	&90.9	&217.9	\\
time bd+moy (s)    		& 	&46.4	&69.4	&54.4	&35.6	\\
\hline
\hline
$E_{CIPSI} - E_{FCI} ~(10^{-6}~a.u.)$ & & & & &  \\
$\Delta E_1 $    		&	& 1.61	&1.75	&1973.	&1.90\\
$\Delta E_2 $    		&	& 2.49	&2.81	&36.1	&2.94\\
$\Delta E_3 $   	 	&	& 0.70	&0.83	&529.7	&0.90\\
$\Delta E_4 $   	 	&	& 0.71	&0.84	&529.7	&0.91\\
$\Delta E_5 $   	 	&	& 2.73	&3.03	&3.97	&3.19 \\
$\Delta E_6 $   	 	&	& 3.25	&3.06	&3.17	&3.20 \\
$\Delta E_7 $   	 	&	& 0.91	&1.13	&1187.6	&1.21 \\
$\Delta E_8$    		&	& 0.96	&1.14	&1187.7	&1.22 \\
$\Delta E_9 $  		  	&	& 1.38	&1.22	&2686.0	&1.32 \\
$\Delta E_{10} $  	 	&	& 2.35	&0.66	&1033.5	&0.80 \\
$\Delta E_{11} $ 	  	&	& 7.91	&3.56	&3.40	&3.82\\
\hline
\hline
$\Delta TDM (\%)$		&	&0.0002	&0.0002	&0.38	&0.0002\\
\hline
 \end{tabular}
 \caption{\label{table32} \small Computation of RbCa PECs at $R=32.0~a.u.$. All tests were done for 20 $\Sigma$ states with a value of ${ENVP\_max}=10^{-5}~a.u.$} 
 \end{center}
\end{table*}


\end{document}
